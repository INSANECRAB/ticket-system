(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{8312:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return n(1854)}])},5402:function(e,t,n){"use strict";n.d(t,{Z:function(){return d}});var s=n(5893),r=n(7294),a=n(7642),l=n(9090),o=n(3454),i=n(1876).Buffer;let c=null;function d(e){let{ticketId:t,userName:n}=e,[d,u]=(0,r.useState)([]),[m,x]=(0,r.useState)(""),[f,h]=(0,r.useState)(null),[p,g]=(0,r.useState)(!1),b=(0,r.useRef)(null);(0,r.useEffect)(()=>{l.Z.get("/tickets/".concat(t,"/messages")).then(e=>{u(e.data.messages||[])})},[t]),(0,r.useEffect)(()=>((c=(0,a.io)(o.env.NEXT_PUBLIC_SOCKET_URL||"http://localhost:4000",{transports:["websocket"]})).on("connect",()=>g(!0)),c.on("disconnect",()=>g(!1)),c.emit("join",{ticketId:t,userName:n}),c.on("chat",e=>{u(t=>[...t,e])}),c.on("history",e=>{u(e)}),()=>{null==c||c.disconnect()}),[t,n]),(0,r.useEffect)(()=>{var e;null===(e=b.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[d]);let y=async e=>{let s,r;if(e.preventDefault(),!m&&!f)return;if(f){let e=await f.arrayBuffer(),t=i.from(e).toString("base64");r={name:f.name,data:t,mimetype:f.type},s={name:f.name,url:"#"}}let a={id:Math.random().toString(),user:n,content:m,createdAt:new Date().toLocaleString(),file:s};u(e=>[...e,a]),null==c||c.emit("chat",{ticketId:t,user:n,content:m,createdAt:new Date().toISOString(),file:r}),x(""),h(null)};return(0,s.jsxs)("div",{className:"bg-white rounded-2xl shadow-xl p-6 max-w-lg mx-auto border border-gray-100",children:[(0,s.jsxs)("div",{className:"font-bold mb-4 text-lg flex items-center gap-2",children:["실시간 채팅",p?(0,s.jsx)("span",{className:"text-green-500 text-base",children:"●"}):(0,s.jsx)("span",{className:"text-gray-400 text-base",children:"●"})]}),(0,s.jsxs)("div",{className:"h-64 overflow-y-auto border rounded-lg p-3 mb-4 bg-gray-50 space-y-3",children:[d.map(e=>(0,s.jsx)("div",{className:"flex flex-col ".concat(e.user===n?"items-end":"items-start"),children:(0,s.jsxs)("div",{className:"max-w-[80%] px-4 py-2 rounded-2xl shadow-sm ".concat(e.user===n?"bg-blue-100 text-blue-900":"bg-gray-200 text-gray-800"),children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("span",{className:"font-semibold text-sm",children:e.user}),(0,s.jsx)("span",{className:"text-xs text-gray-500",children:e.createdAt})]}),(0,s.jsx)("div",{className:"whitespace-pre-line break-words text-sm",children:e.content}),e.file&&(0,s.jsxs)("div",{className:"mt-2",children:[(0,s.jsx)("a",{href:e.file.url,className:"text-xs text-blue-600 underline",download:!0,children:decodeURIComponent(e.file.name)}),/\.(png|jpe?g|gif|bmp|webp)$/i.test(decodeURIComponent(e.file.name))&&(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)("img",{src:e.file.url,alt:decodeURIComponent(e.file.name),className:"max-w-[200px] rounded-lg border"})})]})]})},e.id)),(0,s.jsx)("div",{ref:b})]}),(0,s.jsxs)("form",{onSubmit:y,className:"flex flex-col sm:flex-row gap-2 items-stretch",children:[(0,s.jsx)("input",{type:"text",className:"flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-200 text-base",placeholder:"메시지 입력",value:m,onChange:e=>x(e.target.value)}),(0,s.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer bg-gray-100 px-3 py-2 rounded-lg border border-gray-200 hover:bg-gray-200 transition text-sm",children:["파일 선택",(0,s.jsx)("input",{type:"file",onChange:e=>{var t;return h((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)},className:"hidden"})]}),(0,s.jsx)("button",{type:"submit",className:"bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition font-semibold disabled:opacity-50",disabled:!m&&!f,children:"전송"})]}),f&&(0,s.jsxs)("div",{className:"text-xs text-gray-500 mt-2",children:["선택된 파일: ",f.name]})]})}},4820:function(e,t,n){"use strict";n.d(t,{Z:function(){return c}});var s=n(5893),r=n(7294),a=n(1664),l=n.n(a),o=n(1163),i=n(4231);function c(e){let{children:t}=e,n=(0,o.useRouter)(),{token:a,logout:c,user:d,fetchUser:u}=(0,i.a)();return r.useEffect(()=>{a&&!d&&u()},[a,d,u]),(0,s.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50",children:[(0,s.jsxs)("nav",{className:"sticky top-0 z-20 bg-white/90 backdrop-blur shadow-md px-8 py-4 flex items-center justify-between border-b",children:[(0,s.jsx)(l(),{href:"/",children:(0,s.jsx)("span",{className:"font-extrabold text-2xl text-blue-700 tracking-tight cursor-pointer select-none",children:"Ticket System"})}),(0,s.jsx)("div",{className:"flex items-center gap-4",children:a?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(l(),{href:"/tickets",children:(0,s.jsx)("span",{className:"hover:underline cursor-pointer text-blue-700 font-semibold px-3 py-1 rounded transition",children:"티켓 목록"})}),(0,s.jsx)(l(),{href:"/mypage",children:(0,s.jsx)("span",{className:"hover:underline cursor-pointer text-gray-700 font-semibold px-3 py-1 rounded transition",children:"내 정보"})}),(null==d?void 0:d.role)==="ADMIN"&&(0,s.jsx)(l(),{href:"/admin",children:(0,s.jsx)("span",{className:"hover:underline cursor-pointer text-red-700 font-semibold px-3 py-1 rounded transition",children:"관리자"})}),(0,s.jsx)("button",{onClick:()=>{c(),n.push("/login")},className:"bg-gray-100 px-3 py-1 rounded hover:bg-gray-200 text-gray-700 font-semibold border border-gray-200 transition",children:"로그아웃"})]}):(0,s.jsx)(l(),{href:"/login",children:(0,s.jsx)("span",{className:"bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 cursor-pointer font-semibold transition",children:"로그인"})})})]}),(0,s.jsx)("main",{className:"max-w-3xl mx-auto py-12 px-4 md:px-0",children:t})]})}},1854:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return c}});var s=n(5893),r=n(7294),a=n(1163),l=n(5402),o=n(4231),i=n(4820);function c(){let e=(0,a.useRouter)(),{token:t}=(0,o.a)();return(0,r.useEffect)(()=>{t?e.replace("/tickets"):e.replace("/login")},[t,e]),(0,s.jsx)(i.Z,{children:(0,s.jsx)("div",{className:"my-8",children:(0,s.jsx)(l.Z,{ticketId:"main",userName:"익명"})})})}},4231:function(e,t,n){"use strict";n.d(t,{a:function(){return a}});var s=n(4529),r=n(9090);let a=(0,s.Ue)((e,t)=>({token:localStorage.getItem("token"),user:null,setToken:n=>{localStorage.setItem("token",n),e({token:n}),t().fetchUser()},setUser:t=>e({user:t}),fetchUser:async()=>{let n=t().token;if(!n)return e({user:null});try{let t=await r.Z.get("/users/me",{headers:{Authorization:"Bearer ".concat(n)}});e({user:t.data})}catch(t){e({user:null})}},logout:()=>{localStorage.removeItem("token"),e({token:null,user:null})}}))},9090:function(e,t,n){"use strict";var s=n(7066),r=n(3454);let a=s.Z.create({baseURL:r.env.NEXT_PUBLIC_API_URL||"http://localhost:4000"});t.Z=a}},function(e){e.O(0,[66,927,642,888,774,179],function(){return e(e.s=8312)}),_N_E=e.O()}]);